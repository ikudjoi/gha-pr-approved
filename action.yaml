name: Check if Pull Request is approved
description: Check number of pull request approvals meets the requested value
inputs:
  pr-number:
    description: Number of the pull request
    required: true
    type: string
  fail:
    description: If true will fail if required count of approvals is not met
    required: false
    default: false
    type: boolean
outputs:
  result:
    description: Truth value whether there is required number of approving reviews on the pull request
    value: ${{ steps.check.outputs.result }}
runs:
  using: composite
  steps:
    - name: Check approving review count
      uses: actions/github-script@v6
      id: check
      with:
        result-encoding: string
        script: |
          // Get approved pull requests from the GitHub API.
          const repo = `${context.repo.owner}/${context.repo.repo}`;
          const query = `repo:${repo}+is:pr+is:open+review:approved`
          const pulls = await github.rest.search.issuesAndPullRequests({
            q: query,
          });
          
          this_pr_find_result = pulls.data.items.find((i) => { return i.number == ${{ inputs.pr-number }}; })
          approved = (typeof this_pr_find_result !== "undefined");

          if (approved)
          {
            msg = `The pull request is approved!`;
            console.log(msg);
            return true;
          }
          
          msg = `The pull request is not approved!`;
          if (${{ inputs.fail }}) {
            core.setFailed(msg);
          }
          else {
            console.log(msg);
          }
        
          return false;
